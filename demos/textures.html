<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
    *{
    	margin:0;padding:0;
    }
    
    #fps {
    	position: absolute; top:0;left:0;z-index:2;
    }
    </style>
 </head>
<body>
	<div id="fps"></div>
    <!-- dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v2.0.0-beta-21/epiccanvas.js" crossorigin='anonymous'></script>
    
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v2.0.0-beta-21/shaders/vertexPhongTexture.js" crossorigin='anonymous'></script>
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v2.0.0-beta-21/shaders/fragmentPhongTexture.js" crossorigin='anonymous'></script>
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v2.0.0-beta-21/primitives/cube.js" crossorigin='anonymous'></script>

<script>




// Globals
let s, w, h, ec, program, texture, texture2, fb, fps;

const textureRenderingFunction = () => {
	ec.aspectRatio = 1;
    ec.clearColor = [0.5, 0.7, 0.8, 1];
    ec.clearScreen();
    ec.setTexture(texture2);
    ec.drawShape(program, s);
};

let oldt = 0;
const loop = (t) => {
	dt = t - oldt; 
	oldt = t;
	fps.innerText = ""+(1/dt*1000).toFixed(2);
	
	// Update shape
	ec.rotateModelMatrix(s, 0.01, [0,1,0]);
    ec.rotateModelMatrix(s, Math.sin(t/2000)* 0.01, [0,0,1]);
	
	// Main Render
	ec.setViewport(0,0,w,h)
	ec.aspectRatio = w/h
    ec.clearColor = [0.7, 0.5, 0.8, 1.0];
    ec.clearScreen();
    ec.setTexture(texture);
    ec.drawShape(program, s);
    
    // Option 1:
    //Texture rendering
    ec.bindFramebuffer(fb);
    ec.setViewport(0,0,512,512)
    textureRenderingFunction();
    ec.unbindFramebuffer();
    ec.regenerateMipmaps(texture, 512, 512)
    //End of texture rendering

    // Option 2:
    // this line of code below is almost equivalent to above texture rendering code, except it creates and destroys a framebuffer everytime, little slower (maybe)
    // ec.renderToTexture(texture, 512, 512, textureRenderingFunction);
    
    requestAnimationFrame(loop);
};


const main = () => {
    try {
    	fps = document.querySelector("#fps");
    
        // Create canvas
        const size = Math.min(innerWidth, innerHeight);
        const width = w =  innerWidth;//size;
        const height = h = innerHeight;//size;
        ec = new EpicCanvas(width, height, "body");

        // Set up camera
        ec.lookAt([0, 0, 5], [0, 0, 0], [0, 1, 0]);
        ec.fieldOfView = Math.PI/3
        ec.aspectRatio = w/h

        // Create shader program
        program = ec.makeProgram(vsPhongTexture, fsPhongTexture);

        // Create a cube
        s = Cube(ec);

        // Create and initialize texture
        texture =  ec.createTexture(512,512);
        texture2 =  ec.loadTexture(null)
        
        // Create framebuffer
        fb = ec.createFramebuffer(texture, 512,512);

        // Lighting setup
        ec.ambientColor = [0.25,0.25,0.125];
        ec.directionalColor = [0.5,0.5,0.0]
        ec.directionalVector = [0,0.7,0.7] //direction the light comes from
        ec.pointLightColor = [0.2,0.45,0.75]
        ec.pointLightPosition = [0,1.5,5]

        // Start the loop
        requestAnimationFrame(loop);
    } catch (e) {
        console.error("Error in main:", e);
    }
};

onload = main;
</script>
</body>
</html>
