
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
 </head>
<body>
    <!-- dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v1.16.18/epiccanvas.js" crossorigin='anonymous'></script>
    <script src="https://cdn.jsdelivr.net/gh/paul-caron/EpicCanvas@v1.16.18/primitives/cube.js" crossorigin='anonymous'></script>

<script>
const vsSource = `
attribute vec4 aVertexPosition;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying vec3 vDirection;

void main() {
    // Only apply rotation part of modelViewMatrix (remove translation)
    mat4 viewRotation = mat4(mat3(uModelViewMatrix));

    vec4 direction = viewRotation * aVertexPosition;
    vDirection = direction.xyz;

    gl_Position = uProjectionMatrix * viewRotation * vec4(direction.xyz, 1.0);
}`;

const fsSource = `
precision highp float;
uniform samplerCube uCubeMap;
varying vec3 vDirection;

void main() {
    gl_FragColor = textureCube(uCubeMap, normalize(vDirection));
}`;


// Globals
let w, h, epicCanvas, program, cube, cubemap;

const loop = (t) => {
    epicCanvas.rotateMatrix(epicCanvas.matrices.modelViewMatrix, 0.01, [0,0.7,0.7])
    epicCanvas.clearScreen();
    epicCanvas.setCubeMap(cubemap);
    epicCanvas.drawShape(program, cube);
    requestAnimationFrame(loop);
}

const main = async () => {
    try {
        // Create canvas
        const size = Math.min(innerWidth, innerHeight);
        const width = w = size;
        const height = h = size;
        epicCanvas = new EpicCanvas(width, height, "body");
        epicCanvas.fieldOfView = Math.PI / 1.2 ;
        epicCanvas.zNear = 0.1;
        epicCanvas.zFar = 100.0;
        epicCanvas.aspectRatio = width / height;

        // Set up camera
        epicCanvas.lookAt([0, 0, -5], [0, 0, 0], [0, 1, 0]);

        // set up clear color
        epicCanvas.clearColor = [0.5, 0.5, 0, 1];
        epicCanvas.clearScreen();

        // Create shader program
        program = epicCanvas.makeProgram(vsSource, fsSource);

        // create a cube
        cube = Cube(epicCanvas);
        scale(cube, 50,50,50);
        epicCanvas.reloadBufferData(cube);        

        const URLs = [
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/posx.jpg",
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/negx.jpg",
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/posy.jpg",
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/negy.jpg",
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/posz.jpg",
"https://raw.githubusercontent.com/paul-caron/EpicCanvas/refs/heads/master/assets/cubemaps/citadella2/negz.jpg",
        ];
        cubemap = await epicCanvas.loadCubeMap(URLs);

        requestAnimationFrame(loop);


    } catch (e) {
        console.error("Error in main:", e);
    }
};

onload = main;
</script>
</body>
</html>
